{
  "name": "Factory-Execution",
  "nodes": [
    {
      "parameters": {
        "path": "run-project",
        "pathType": "static",
        "httpMethod": "POST",
        "responseMode": "onReceived"
      },
      "id": "run-webhook-trigger",
      "name": "RunWebhookTrigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        180,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "const id = ($json.body?.project_id || $json.project_id || '').toString().trim();\nif (!id || !/^[A-Za-z0-9_-]+$/.test(id)) { throw new Error('Invalid project_id'); }\nreturn [{ json: { project_id: id } }];"
      },
      "id": "parse-id",
      "name": "Parse Project ID",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        430,
        300
      ]
    },
    {
      "parameters": {
        "command": "=set -e\nP=/data/projects/{{$item(0).$node['Parse Project ID'].json.project_id}}\nmkdir -p \"$P/state\" \"$P/logs\" \"$P/repo\" \"$P/tasks\"\nprintf '{\"phase\":\"RUNNING\",\"running\":true,\"updated_at\":\"%s\"}' \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\" > \"$P/state/status.json\"\necho \"Execution started at $(date -u +%Y-%m-%dT%H:%M:%SZ)\" > \"$P/logs/build.log\""
      },
      "id": "mark-running",
      "name": "Mark RUNNING",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        700,
        300
      ]
    },
    {
      "parameters": {
        "command": "=set -e\nPID='{{$item(0).$node['Parse Project ID'].json.project_id}}'\nP=/data/projects/$PID\nSPEC=\"$P/project_spec.md\"\nSTACK=nextjs\nif [ -f \"$SPEC\" ]; then\n  if grep -qi laravel \"$SPEC\"; then STACK=laravel; fi\n  if grep -qi flutter \"$SPEC\"; then STACK=flutter; fi\nfi\ncase \"$STACK\" in\n  nextjs) T=/srv/ai-software-factory/templates/next-store-template ;;\n  laravel) T=/srv/ai-software-factory/templates/laravel-system-template ;;\n  flutter) T=/srv/ai-software-factory/templates/flutter-app-template ;;\n  *) T=/srv/ai-software-factory/templates/next-store-template ;;\nesac\nrm -rf \"$P/repo\"\nmkdir -p \"$P/repo\"\ncp -R \"$T\"/. \"$P/repo\"/\nprintf '{\"stack\":\"%s\"}' \"$STACK\" > \"$P/state/spec.json\"\necho \"Template/scaffold prepared (stack=$STACK)\" >> \"$P/logs/build.log\""
      },
      "id": "apply-template",
      "name": "Apply Template",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        980,
        300
      ]
    },
    {
      "parameters": {
        "command": "=set -e\nPID='{{$item(0).$node['Parse Project ID'].json.project_id}}'\nP=/data/projects/$PID\nSTACK=$(cat \"$P/state/spec.json\" 2>/dev/null | sed -n 's/.*\"stack\"[[:space:]]*:[[:space:]]*\"\\([^\"]\\+\\)\".*/\\1/p')\nSTACK=${STACK:-nextjs}\n( cd \"$P/repo\" && find . -type f | sort ) > \"$P/repo_tree.txt\"\n\nLIVE_URL=\"\"\nif [ \"$STACK\" = \"nextjs\" ]; then\n  echo \"Building static site...\" >> \"$P/logs/build.log\"\n  cd \"$P/repo\"\n  if [ -f package-lock.json ]; then\n    npm ci --include=dev >> \"$P/logs/build.log\" 2>&1\n  else\n    npm install --include=dev >> \"$P/logs/build.log\" 2>&1\n  fi\n  npm run build >> \"$P/logs/build.log\" 2>&1\n  if [ ! -d \"$P/repo/out\" ]; then\n    echo \"No /out produced. Check next.config.mjs output='export'.\" >> \"$P/logs/build.log\"\n    exit 1\n  fi\n  LIVE_DIR=/srv/ai-software-factory/live/$PID\n  rm -rf \"$LIVE_DIR\"\n  mkdir -p \"$LIVE_DIR\"\n  cp -R \"$P/repo/out\"/. \"$LIVE_DIR\"/\n  LIVE_URL=\"https://$PID.petsy.company\"\n  echo \"Live deployed to $LIVE_DIR\" >> \"$P/logs/build.log\"\nfi\n\nmkdir -p \"$P/preview\"\nSPEC_SHORT=$(head -n 60 \"$P/project_spec.md\" | sed 's/&/\\&amp;/g; s/</\\&lt;/g; s/>/\\&gt;/g')\nTREE_SHORT=$(head -n 120 \"$P/repo_tree.txt\" | sed 's/&/\\&amp;/g; s/</\\&lt;/g; s/>/\\&gt;/g')\ncat > \"$P/preview/index.html\" <<EOF\n<!doctype html><html><head><meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"><title>Preview $PID</title><style>body{font-family:Inter,Arial,sans-serif;margin:24px;line-height:1.5}pre{background:#111;color:#eaeaea;padding:12px;border-radius:8px;overflow:auto}a{color:#2563eb}</style></head><body><h1>Project Preview: $PID</h1><p>This is an online delivery preview generated by AI Software Factory.</p><p><a href=\"/factory-preview/$PID/$PID.zip\">Download ZIP</a></p><p><a href=\"$LIVE_URL\">Open Live Site</a></p><h2>Spec (excerpt)</h2><pre>$SPEC_SHORT</pre><h2>Generated files (excerpt)</h2><pre>$TREE_SHORT</pre></body></html>\nEOF\n\ntar -cf \"$P/$PID.zip\" -C \"$P/repo\" .\nBR=deliver/$PID\nPREVIEW_URL=https://petsy.company/factory-preview/$PID/preview/index.html\nprintf '{\"phase\":\"PASSED\",\"running\":false,\"github_branch\":\"%s\",\"zip\":\"%s\",\"preview_url\":\"%s\",\"live_url\":\"%s\",\"updated_at\":\"%s\"}' \"$BR\" \"$P/$PID.zip\" \"$PREVIEW_URL\" \"$LIVE_URL\" \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\" > \"$P/state/status.json\"\necho \"Execution completed successfully\" >> \"$P/logs/build.log\""
      },
      "id": "finalize",
      "name": "Finalize",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        1270,
        300
      ]
    },
    {
      "parameters": {
        "command": "=set -e\nPID='{{$item(0).$node['Parse Project ID'].json.project_id}}'\nchroot /host /srv/ai-software-factory/scripts/monetize_project.sh \"$PID\""
      },
      "id": "monetize-project",
      "name": "Monetization Step",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        980,
        180
      ]
    },
    {
      "parameters": {
        "command": "=set -e\nPID='{{$item(0).$node['Parse Project ID'].json.project_id}}'\necho \"Reviewer Agent: validating monetized project $PID\" >> /data/projects/$PID/logs/build.log\n[ -f /data/projects/$PID/server.js ]"
      },
      "id": "reviewer-agent",
      "name": "Reviewer Agent",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        1220,
        180
      ]
    },
    {
      "parameters": {
        "command": "=set -e\nPID='{{$item(0).$node['Parse Project ID'].json.project_id}}'\necho \"Release Agent: final checks before deploy $PID\" >> /data/projects/$PID/logs/build.log"
      },
      "id": "release-agent",
      "name": "Release Agent",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        1460,
        180
      ]
    },
    {
      "parameters": {
        "command": "=set -e\nPID='{{$item(0).$node['Parse Project ID'].json.project_id}}'\nchroot /host /srv/ai-software-factory/scripts/deploy_project.sh \"$PID\" >> /data/projects/$PID/logs/build.log 2>&1"
      },
      "id": "deploy-step",
      "name": "Deploy Step",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        1700,
        180
      ]
    }
  ],
  "connections": {
    "Parse Project ID": {
      "main": [
        [
          {
            "node": "Mark RUNNING",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark RUNNING": {
      "main": [
        [
          {
            "node": "Apply Template",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Apply Template": {
      "main": [
        [
          {
            "node": "Monetization Step",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RunWebhookTrigger": {
      "main": [
        [
          {
            "node": "Parse Project ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Monetization Step": {
      "main": [
        [
          {
            "node": "Reviewer Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reviewer Agent": {
      "main": [
        [
          {
            "node": "Release Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Release Agent": {
      "main": [
        [
          {
            "node": "Deploy Step",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deploy Step": {
      "main": [
        [
          {
            "node": "Finalize",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "pinData": {},
  "versionId": "1"
}