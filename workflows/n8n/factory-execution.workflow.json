{
  "name": "Factory-Execution",
  "nodes": [
    {
      "parameters": { "updates": ["message"] },
      "id": "tg-trigger",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [180, 420]
    },
    {
      "parameters": {
        "jsCode": "const text = ($json.message?.text || '').trim();\nconst m = text.match(/^\\/run\\s+([a-zA-Z0-9_\\-]+)/i);\nreturn [{ json: {\n  chat_id: $json.message?.chat?.id,\n  message_id: $json.message?.message_id,\n  command_ok: !!m,\n  project_id: m ? m[1] : null\n}}];"
      },
      "id": "parse-run",
      "name": "Parse /run",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [420, 420]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            { "value1": "={{$json.command_ok}}", "operation": "isTrue" }
          ]
        }
      },
      "id": "if-valid-run",
      "name": "If Valid /run",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [650, 420]
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "sendMessage",
        "chatId": "={{$json.chat_id}}",
        "text": "Invalid command. Use: /run <project_id>"
      },
      "id": "reply-invalid",
      "name": "Reply Invalid",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [880, 620]
    },
    {
      "parameters": {
        "command": "=set -e\nP=/data/projects/{{$json.project_id}}\n[ -d \"$P\" ]\nmkdir -p \"$P/repo\" \"$P/state\" \"$P/logs\"\nprintf 'PROJECT=%s\\n' '{{$json.project_id}}' > \"$P/state/context.env\"\n( test -f \"$P/project_spec.md\" && cat \"$P/project_spec.md\" ) > \"$P/state/spec_input.md\"\nfind \"$P/tasks\" -type f -name '*.md' | sort > \"$P/state/tasks_list.txt\""
      },
      "id": "load-project-files",
      "name": "Load Project Files",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "command": "=python3 - <<'PY'\nimport json,re,os\npid='{{$json.project_id}}'\np=f'/data/projects/{pid}/project_spec.md'\ntext=open(p,'r',encoding='utf-8').read() if os.path.exists(p) else ''\nt=text.lower()\nstack='nextjs'\nif 'laravel' in t: stack='laravel'\nelif 'flutter' in t: stack='flutter'\nprint(json.dumps({'project_id':pid,'stack':stack}))\nPY"
      },
      "id": "detect-stack-cmd",
      "name": "Detect Stack",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "jsCode": "let out={}; try{ out=JSON.parse($json.stdout||'{}'); }catch(e){ out={project_id:$item(0).$node['Parse /run'].json.project_id,stack:'nextjs'} }\nreturn [{json:{...$item(0).$node['Parse /run'].json, ...out}}];"
      },
      "id": "parse-stack-json",
      "name": "Parse Stack",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1330, 300]
    },
    {
      "parameters": {
        "jsCode": "const s=($json.stack||'nextjs').toLowerCase();\nconst map={nextjs:'/srv/ai-software-factory/templates/next-store-template',laravel:'/srv/ai-software-factory/templates/laravel-system-template',flutter:'/srv/ai-software-factory/templates/flutter-app-template'};\nreturn [{json:{...$json,template_path: map[s]||map.nextjs}}];"
      },
      "id": "pick-template",
      "name": "Pick Template",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1540, 300]
    },
    {
      "parameters": {
        "command": "=set -e\nP=/data/projects/{{$json.project_id}}\nT='{{$json.template_path}}'\nmkdir -p \"$P/repo\"\nif [ -d \"$T\" ]; then cp -R \"$T\"/. \"$P/repo\"/; else echo 'Template not found, continuing with empty repo' > \"$P/logs/template.warn.log\"; fi"
      },
      "id": "copy-template",
      "name": "Copy Template",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1770, 300]
    },
    {
      "parameters": {
        "jsCode": "const agents=['frontend','backend','db','devops'];\nreturn agents.map(a=>({json:{...$item(0).$node['Pick Template'].json,agent_type:a}}));"
      },
      "id": "fanout-agents",
      "name": "Fanout Agents",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1980, 300]
    },
    {
      "parameters": {
        "jsCode": "const t=($json.agent_type||'').toLowerCase();\nconst modelMap={pm:'deepseek/deepseek-chat',frontend:'anthropic/claude-3.5-sonnet',backend:'mistral/devstral',db:'deepseek/deepseek-chat',qa:'mistral/devstral',devops:'mistral/devstral',marketing:'anthropic/claude'};\nconst fallbackByModel={'mistral/devstral':'deepseek/deepseek-chat','anthropic/claude-3.5-sonnet':'deepseek/deepseek-chat','anthropic/claude':'deepseek/deepseek-chat','deepseek/deepseek-chat':'mimov2'};\nlet m=modelMap[t]||'deepseek/deepseek-chat';\nreturn [{json:{...$json,model:m,fallback:fallbackByModel[m]||null}}];"
      },
      "id": "model-router-inline",
      "name": "Model Router",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2200, 300]
    },
    {
      "parameters": { "amount": 1, "unit": "seconds" },
      "id": "wait-rl",
      "name": "Wait RL",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [2390, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://openrouter.ai/api/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "=Bearer {{$env.OPENROUTER_API_KEY}}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": $json.model,\n  \"temperature\": 0.1,\n  \"messages\": [\n    {\"role\":\"system\",\"content\":\"You are a software agent. Output ONLY PATCH blocks in this format: ```path/to/file\\n<full file code>``` . No explanations.\"},\n    {\"role\":\"user\",\"content\": \"Agent: \" + $json.agent_type + \". Project: \" + $json.project_id + \". Stack: \" + $json.stack + \". Read spec/tasks and produce code patches.\"}\n  ]\n}"
      },
      "id": "agent-call",
      "name": "Agent Call",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2600, 300]
    },
    {
      "parameters": {
        "command": "=python3 - <<'PY'\nimport os,re\npid='{{$json.project_id}}'\nagent='{{$json.agent_type}}'\ntext='''{{$json.choices[0].message.content.replace("'''","\"\"\"") if $json.choices else ''}}'''\nroot=f'/data/projects/{pid}/repo'\nos.makedirs(root,exist_ok=True)\nfor m in re.finditer(r'```([^\\n`]+)\\n([\\s\\S]*?)```', text):\n    path=m.group(1).strip()\n    code=m.group(2)\n    full=os.path.normpath(os.path.join(root,path))\n    if not full.startswith(root):\n        continue\n    os.makedirs(os.path.dirname(full),exist_ok=True)\n    open(full,'w',encoding='utf-8').write(code)\nopen(f'/data/projects/{pid}/logs/{agent}.patch.log','w',encoding='utf-8').write(text)\nprint('ok')\nPY"
      },
      "id": "apply-agent-patches",
      "name": "Apply Agent Patches",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [2830, 300]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "multiplex"
      },
      "id": "join-agent-outputs",
      "name": "Join Agent Outputs",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [3060, 300]
    },
    {
      "parameters": {
        "command": "=set -e\nP=/data/projects/{{$json.project_id}}\n( cd \"$P/repo\" && find . -type f | sort ) > \"$P/repo_tree.txt\"\nif [ -f \"$P/repo/package.json\" ]; then (cd \"$P/repo\" && npm test || true) > \"$P/logs/test.log\" 2>&1; else echo 'No tests configured' > \"$P/logs/test.log\"; fi"
      },
      "id": "integration-and-tests",
      "name": "Integration + Tests",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [3290, 300]
    },
    {
      "parameters": { "amount": 1, "unit": "seconds" },
      "id": "wait-qa-1",
      "name": "Wait QA #1",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [3490, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://openrouter.ai/api/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "=Bearer {{$env.OPENROUTER_API_KEY}}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"model\":\"mistral/devstral\",\"messages\":[{\"role\":\"system\",\"content\":\"You are QA. Return ONLY PATCH blocks to fix issues from logs/tests.\"},{\"role\":\"user\",\"content\":\"Project {{$json.project_id}}. Analyze tests/logs and return fixes.\"}],\"temperature\":0.1}"
      },
      "id": "qa-call-1",
      "name": "QA Agent #1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [3690, 300]
    },
    {
      "parameters": {
        "command": "=python3 - <<'PY'\nimport os,re\npid='{{$json.project_id}}'\ntext='''{{$json.choices[0].message.content.replace("'''","\"\"\"") if $json.choices else ''}}'''\nroot=f'/data/projects/{pid}/repo'\nfor m in re.finditer(r'```([^\\n`]+)\\n([\\s\\S]*?)```', text):\n    path=m.group(1).strip(); code=m.group(2)\n    full=os.path.normpath(os.path.join(root,path))\n    if full.startswith(root):\n      os.makedirs(os.path.dirname(full),exist_ok=True); open(full,'w',encoding='utf-8').write(code)\nopen(f'/data/projects/{pid}/logs/qa1.patch.log','w',encoding='utf-8').write(text)\nprint('ok')\nPY"
      },
      "id": "apply-qa-1",
      "name": "Apply QA #1",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [3910, 300]
    },
    {
      "parameters": { "amount": 1, "unit": "seconds" },
      "id": "wait-qa-2",
      "name": "Wait QA #2",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1,
      "position": [4100, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://openrouter.ai/api/v1/chat/completions",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            { "name": "Authorization", "value": "=Bearer {{$env.OPENROUTER_API_KEY}}" },
            { "name": "Content-Type", "value": "application/json" }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"model\":\"mistral/devstral\",\"messages\":[{\"role\":\"system\",\"content\":\"Second QA pass. Return ONLY final PATCH blocks.\"},{\"role\":\"user\",\"content\":\"Project {{$json.project_id}} second QA loop.\"}],\"temperature\":0.1}"
      },
      "id": "qa-call-2",
      "name": "QA Agent #2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [4300, 300]
    },
    {
      "parameters": {
        "command": "=python3 - <<'PY'\nimport os,re\npid='{{$json.project_id}}'\ntext='''{{$json.choices[0].message.content.replace("'''","\"\"\"") if $json.choices else ''}}'''\nroot=f'/data/projects/{pid}/repo'\nfor m in re.finditer(r'```([^\\n`]+)\\n([\\s\\S]*?)```', text):\n    path=m.group(1).strip(); code=m.group(2)\n    full=os.path.normpath(os.path.join(root,path))\n    if full.startswith(root):\n      os.makedirs(os.path.dirname(full),exist_ok=True); open(full,'w',encoding='utf-8').write(code)\nopen(f'/data/projects/{pid}/logs/qa2.patch.log','w',encoding='utf-8').write(text)\nprint('ok')\nPY"
      },
      "id": "apply-qa-2",
      "name": "Apply QA #2",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [4520, 300]
    },
    {
      "parameters": {
        "command": "=set -e\nP=/data/projects/{{$json.project_id}}\nZIP=\"$P/{{$json.project_id}}.zip\"\n( cd \"$P\" && zip -rq \"$ZIP\" repo repo_tree.txt project_spec.md tasks state logs )\ncd \"$P/repo\"\ngit init -b main >/dev/null 2>&1 || true\ngit add .\ngit commit -m 'deliver {{$json.project_id}}' >/dev/null 2>&1 || true\ngit branch -M 'deliver/{{$json.project_id}}'\nif [ -n \"$GITHUB_TOKEN\" ] && [ -n \"$GITHUB_REPO\" ]; then\n  git remote remove origin >/dev/null 2>&1 || true\n  git remote add origin \"https://$GITHUB_TOKEN@github.com/$GITHUB_REPO.git\"\n  git push -u origin 'deliver/{{$json.project_id}}' || true\nfi\nprintf '{\"zip_path\":\"%s\",\"branch\":\"deliver/{{$json.project_id}}\",\"github\":\"https://github.com/%s/tree/deliver/{{$json.project_id}}\"}' \"$ZIP\" \"${GITHUB_REPO:-steev2058/ai-software-factory}\""
      },
      "id": "package-and-push",
      "name": "ZIP + Push GitHub",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [4750, 300]
    },
    {
      "parameters": {
        "jsCode": "let out={}; try{ out=JSON.parse($json.stdout||'{}'); }catch(e){ out={zip_path:'/data/projects/'+$item(0).$node['Parse /run'].json.project_id+'/'+$item(0).$node['Parse /run'].json.project_id+'.zip',branch:'deliver/'+$item(0).$node['Parse /run'].json.project_id,github:'(push not configured)'} }\nreturn [{json:{...$item(0).$node['Parse /run'].json,...out}}];"
      },
      "id": "parse-delivery",
      "name": "Parse Delivery",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [4960, 300]
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "sendMessage",
        "chatId": "={{$json.chat_id}}",
        "text": "=âœ… Delivery complete\nproject_id: {{$json.project_id}}\nbranch: {{$json.branch}}\nGitHub: {{$json.github}}\nZIP: {{$json.zip_path}}"
      },
      "id": "reply-done",
      "name": "Reply Done",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [5170, 300]
    }
  ],
  "connections": {
    "Telegram Trigger": { "main": [[{ "node": "Parse /run", "type": "main", "index": 0 }]] },
    "Parse /run": { "main": [[{ "node": "If Valid /run", "type": "main", "index": 0 }]] },
    "If Valid /run": {
      "main": [
        [{ "node": "Load Project Files", "type": "main", "index": 0 }],
        [{ "node": "Reply Invalid", "type": "main", "index": 0 }]
      ]
    },
    "Load Project Files": { "main": [[{ "node": "Detect Stack", "type": "main", "index": 0 }]] },
    "Detect Stack": { "main": [[{ "node": "Parse Stack", "type": "main", "index": 0 }]] },
    "Parse Stack": { "main": [[{ "node": "Pick Template", "type": "main", "index": 0 }]] },
    "Pick Template": { "main": [[{ "node": "Copy Template", "type": "main", "index": 0 }]] },
    "Copy Template": { "main": [[{ "node": "Fanout Agents", "type": "main", "index": 0 }]] },
    "Fanout Agents": { "main": [[{ "node": "Model Router", "type": "main", "index": 0 }]] },
    "Model Router": { "main": [[{ "node": "Wait RL", "type": "main", "index": 0 }]] },
    "Wait RL": { "main": [[{ "node": "Agent Call", "type": "main", "index": 0 }]] },
    "Agent Call": { "main": [[{ "node": "Apply Agent Patches", "type": "main", "index": 0 }]] },
    "Apply Agent Patches": { "main": [[{ "node": "Join Agent Outputs", "type": "main", "index": 0 }]] },
    "Join Agent Outputs": { "main": [[{ "node": "Integration + Tests", "type": "main", "index": 0 }]] },
    "Integration + Tests": { "main": [[{ "node": "Wait QA #1", "type": "main", "index": 0 }]] },
    "Wait QA #1": { "main": [[{ "node": "QA Agent #1", "type": "main", "index": 0 }]] },
    "QA Agent #1": { "main": [[{ "node": "Apply QA #1", "type": "main", "index": 0 }]] },
    "Apply QA #1": { "main": [[{ "node": "Wait QA #2", "type": "main", "index": 0 }]] },
    "Wait QA #2": { "main": [[{ "node": "QA Agent #2", "type": "main", "index": 0 }]] },
    "QA Agent #2": { "main": [[{ "node": "Apply QA #2", "type": "main", "index": 0 }]] },
    "Apply QA #2": { "main": [[{ "node": "ZIP + Push GitHub", "type": "main", "index": 0 }]] },
    "ZIP + Push GitHub": { "main": [[{ "node": "Parse Delivery", "type": "main", "index": 0 }]] },
    "Parse Delivery": { "main": [[{ "node": "Reply Done", "type": "main", "index": 0 }]] }
  },
  "active": false,
  "settings": { "executionOrder": "v1" },
  "pinData": {},
  "versionId": "1"
}
